language: python

services:
    - docker

env:
    DOCKER_TAG=$(if [ "$TRAVIS_BRANCH" != "master" ]; then echo dev-${TRAVIS_BRANCH}; else echo "latest"; fi)

jobs:
    include:
      - stage: check
        install:
            - python -m pip install pre-commit
        script:
            - pre-commit install
            - pre-commit run --all-files
      - stage: build docker images
        install:
        before_script:
            - docker pull inspiregroup/artemis-backend || true
            - docker pull inspiregroup/artemis-frontend || true
            - docker pull inspiregroup/artemis-monitor || true
        script:
            - docker build --pull --cache-from inspiregroup/artemis-backend -t artemis_backend backend/
            - docker tag artemis_backend:latest inspiregroup/artemis-backend:${DOCKER_TAG}
            - docker push inspiregroup/artemis-backend:${DOCKER_TAG}
            - docker build --pull --cache-from inspiregroup/artemis-frontend -t artemis_frontend frontend/
            - docker tag artemis_frontend:latest inspiregroup/artemis-frontend:${DOCKER_TAG}
            - docker push inspiregroup/artemis-frontend:${DOCKER_TAG}
            - docker build --pull --cache-from inspiregroup/artemis-monitor -t artemis_monitor monitor/
            - docker tag artemis_monitor:latest inspiregroup/artemis-monitor:${DOCKER_TAG}
            - docker push inspiregroup/artemis-monitor:${DOCKER_TAG}
      - stage: test
        name: TestCafe
        install:
        before_script:
            - docker pull inspiregroup/artemis-backend:${DOCKER_TAG} || true
            - docker pull inspiregroup/artemis-frontend:${DOCKER_TAG} || true
            - docker pull inspiregroup/artemis-monitor:${DOCKER_TAG} || true
        script:
            - docker-compose -f docker-compose.testcafe.yaml up --abort-on-container-exit
      - name: BackendTest
        install:
            - pip install codecov
        before_script:
            - docker pull inspiregroup/artemis-backend:${DOCKER_TAG} || true
            - docker pull inspiregroup/artemis-frontend:${DOCKER_TAG} || true
            - docker pull inspiregroup/artemis-monitor:${DOCKER_TAG} || true
        script:
            - docker-compose -f backend/docker-compose.test-backend.yml up --abort-on-container-exit
        after_success:
            - codecov
